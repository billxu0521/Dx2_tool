<!DOCTYPE html>
<html>
<head>

    <title>sb</title>  
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js'></script>
<script src='PapaParse-4.3.2/papaparse.js'></script>

<script type="text/javascript">
var url_1 = 'https://billxu0521.github.io/Dx2_tool/二身表.csv';
var url_2 = 'https://billxu0521.github.io/Dx2_tool/全惡魔.csv';
var twoDevil = {};
var allDevil = {}; //名稱 稀有度0 Grade1 種族2 類型3
var RankAllDevil = []; //重新排序的惡魔
var start = 'スライム';
var target = 'アシェラト';

//網頁開始執行
    $(function ()  {
    // Parse local CSV file

	Papa.parse(url_1, {
		download: true,
	    complete: function(results) {
	        //console.log("Finished:", results.data);
	        var _ary = results.data;
	        for(var a =1 ; a < _ary.length ; a++){
	        	var _res_ary = [];
	        	for(var b =1 ; b < _ary.length ; b++){
	        		_res_ary.push([_ary[b][0],_ary[a][b]]);
	        	}
	        	twoDevil[_ary[a][0]] = _res_ary;
	        	
	        }
	        
	    }
	});
	Papa.parse(url_2, {
		download: true,
	    complete: function(results) {
	        //console.log("Finished:", results.data);
	        var _ary = results.data;
	        for(var a =1 ; a < _ary.length ; a++){
	        	allDevil[_ary[a][0]] = [_ary[a][1],_ary[a][2],_ary[a][3]];
	        	RankAllDevil.push([_ary[a][0],parseInt(_ary[a][2])]);
	        }
	        //排序
	        RankAllDevil = RankAllDevil.sort(function (a, b) {
				//console.log(a[1]);
				return b[1] - a[1];
			});
			//console.log(RankAllDevil);
	    }
    });
});
    //逆二身種類查詢
    function inverseTwoDevil(targetDevil){
    	var _type_ary = [];
    	//查詢二身表反推
		for(var key in twoDevil){
			//console.log(_key);
			for(var key_2 in twoDevil[key]){
				//console.log(twoDevil[_key][_key_2][1]);
				if(twoDevil[key][key_2][1] == allDevil[targetDevil][2]){
					//console.log(target + '/' + allDevil[target][2] + '=' + _key + '+' + twoDevil[_key][_key_2][0]);  //逆二身
					_type_ary.push([key,twoDevil[key][key_2][0]]);
				}
			}
		}
		return _type_ary;
    }

    //排序
	function cus_sort(a,b) {   
	     return a[1] - b[1];      
	}  

    //從目標惡魔查詢組合
    function Devilcombin(targetDevil){
    	var _type_ary = [];//升級組合表
		var _targetdevil_ary = []; //
		var _devil_pack = [];
		var _before_devil = '';//合成目標前一個惡魔
		

		_type_ary = inverseTwoDevil(targetDevil);
		_targetdevil_ary = RankAllDevil;
		_targetdevil_ary = _targetdevil_ary.sort(function (a, b) {
					return b[1] - a[1];
				});
		
		//從全部惡魔找出合成目標前一個惡魔
        for(var i in _targetdevil_ary){
        	//console.log(_targetdevil_ary[i][0] + ':' + _targetdevil_ary[i][1]);
			if(allDevil[targetDevil][2] == allDevil[RankAllDevil[i][0]][2] &&  allDevil[RankAllDevil[i][0]][1] < parseInt(allDevil[targetDevil][1])){
				_before_devil = RankAllDevil[i][0];
				//break;
			}else{
				_before_devil = targetDevil;
			}
		};

		//依照garade大開始重新排序惡魔表
		_targetdevil_ary = _targetdevil_ary.sort(function (a, b) {
			return a[1] - b[1];
		});
		//console.log('target >>' + _targetdevil_ary[0]);
		//console.log(_before_devil+ ':' + allDevil[_before_devil][1]);
		
		//
		for(var x in _type_ary){
			for(var i in _targetdevil_ary){
				var _first_name = _targetdevil_ary[i][0];
				if(allDevil[_first_name][2] != _type_ary[x][0]){
					continue; //無對應種族
				}
				//console.log(_first_name + '/' + allDevil[_first_name][1])
				for(var j in _targetdevil_ary){
					var _second_name = _targetdevil_ary[j][0];
					
					if(allDevil[_second_name][2] != _type_ary[x][1]){
						continue; //無對應種族
					}
					//console.log(allDevil[_second_name][2] );
					//自己跟自己不能合
					if(_targetdevil_ary[i][0] == _targetdevil_ary[j][0]){
						continue; 
					}
					//console.log(((parseInt(_targetdevil_ary[i][1]) + parseInt(_targetdevil_ary[j][1]))/2) + '=>' +allDevil[targetDevil][1] + '/' + allDevil[_before_devil][1]);
					
					//計算grade
					if(_before_devil == targetDevil){
						if((parseInt(_targetdevil_ary[i][1]) + parseInt(_targetdevil_ary[j][1]))/2 > allDevil[targetDevil][1] ){
							continue; 
						}
					}else{
						if((parseInt(_targetdevil_ary[i][1]) + parseInt(_targetdevil_ary[j][1]))/2 > allDevil[targetDevil][1] || (parseInt(_targetdevil_ary[i][1]) + parseInt(_targetdevil_ary[j][1]))/2 <= allDevil[_before_devil][1]){
							continue; 
						}
					}

					_devil_pack.push([_first_name,_second_name]);
					//console.log(_first_name + ':' + allDevil[_first_name][1] + '|' + _second_name + ':' + allDevil[_second_name][1]);
				}
			}
		}
		//console.log(_devil_pack);
		return _devil_pack;

    }

	//找出路徑
	function setLine(){
		start = $('#start').val();
		target = $('#target').val();
		
		console.log('target >>' + target + '/start >>' + start);
		var _pack_ary = [];
		var _res_ary = [];//將結果放在這邊
		//_pack_ary = Devilcombin(target);
		var index = 1;
		var _ary = [];
		var _str = '';
		while(1){
			if(index == 1){
				_str = _str + index + ':';
				_pack_ary = Devilcombin(target);
				for(var i in _pack_ary){
					if(_pack_ary[i][0] == start || _pack_ary[i][1] == start){
						_str = target + '=' + _pack_ary[i][0] + '+' + _pack_ary[i][1];
						console.log(_str);
						return;
					}
					_ary.push(_pack_ary[i]);
					_str = '';
				}
			}else{
				_str = _str + index + ':';
				for(var a in _ary){
					for(var b in _ary[a]){
						_pack_ary = Devilcombin(_ary[a][b]);
						var _new_ary = [];
						_str = _str + _ary[a][0] + '+' + _ary[a][1] + '|';
						for(var i in _pack_ary){
							if(_pack_ary[i][0] == start || _pack_ary[i][1] == start){
								console.log(_str);
								console.log(_ary[a][b] + '=' + _pack_ary[i][0] + '+' + _pack_ary[i][1]);
								return;
							}
							_new_ary.push(_pack_ary[i]);
						}
						
						_ary = _new_ary;
					}
				}
			}
			index ++;
		}

	}
</script>

</head>

<body>
<div>開始:<input type="text" id="start" /></div>
<div>結束:<input type="text" id="target" /></div>
<input type='button' onclick='setLine()' value='check!'></input>

    </body>
</html>

